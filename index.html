<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Materiali</title>
    <!-- Collegamento al Manifest della PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Stili per la scrollbar personalizzata */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Stile per la modale generica */
        .modal {
            display: none; /* Nascosto di default */
            position: fixed; /* Posizione fissa */
            z-index: 1000; /* Valore base per le modali, ma verrà sovrascritto selettivamente */
            left: 0;
            top: 0;
            width: 100%; /* Larghezza intera */
            height: 100%; /* Altezza intera */
            overflow: auto; /* Abilita lo scroll se necessario */
            background-color: rgba(0,0,0,0.4); /* Sfondo semi-trasparente */
            justify-content: center;
            align-items: center;
        }
        /* Assicurati che la modale dei messaggi/conferme sia sempre in cima */
        #myModal {
            z-index: 1003; /* Maggiore di tutte le altre modali */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Stile per la Toast Notification */
        #toast-notification {
            visibility: hidden; /* Nascosta di default */
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1001; /* Appare sopra la modale principale ma sotto quelle più importanti */
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px; /* Posizionata in basso */
            font-size: 17px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }

        #toast-notification.show {
            visibility: visible;
            opacity: 1;
        }

        /* Animazione per il feedback di successo su input */
        @keyframes flash-success {
            0% { border-color: #d1d5db; box-shadow: none; } /* Grigio di default o no shadow */
            25% { border-color: #4ade80; box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.5); } /* Verde brillante */
            50% { border-color: #d1d5db; box-shadow: none; }
            75% { border-color: #4ade80; box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.5); }
            100% { border-color: #d1d5db; box-shadow: none; }
        }

        .flash-success {
            animation: flash-success 1s ease-in-out;
        }

        /* Animazione per il conteggio */
        @keyframes count-flash-green {
            0% { color: inherit; } /* Colore del testo ereditato */
            50% { color: #22c55e; } /* Tailwind green-500 */
            100% { color: inherit; }
        }

        .count-flash-green {
            animation: count-flash-green 0.8s ease-out;
        }

        /* Stili per la modale "Tutti i Materiali Acquisiti" */
        #allBarcodesModal {
            z-index: 1002; /* Impostato per apparire sopra il contenuto principale e allo stesso livello dell'archivio prodotti */
        }
        #allBarcodesModal .modal-content {
            max-width: 600px;
            height: 90%;
            display: flex;
            flex-direction: column;
        }
        #allBarcodesModalContent {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-top: 15px; /* Spazio sotto la sezione di aggiunta/modifica */
        }
        #allBarcodesModalContent .barcode-item-in-modal {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f9fafb;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: background-color 0.2s ease;
            position: relative; /* Per posizionare l'icona di modifica */
        }
        #allBarcodesModalContent .barcode-item-in-modal:hover {
            background-color: #e2e8f0; /* Lighter on hover */
        }
        #allBarcodesModalContent .barcode-item-in-modal p {
            margin-bottom: 5px;
            font-size: 1rem;
            color: #374151;
        }
        #allBarcodesModalContent .barcode-item-in-modal canvas {
            max-width: 90%;
            height: auto;
            border: 1px solid #e5e7eb;
            background-color: white;
            padding: 5px;
            border-radius: 4px;
        }
        .edit-product-icon {
            position: absolute;
            top: 8px;
            right: 8px;
            cursor: pointer;
            color: #4f46e5; /* Indigo */
            background-color: #e0e7ff; /* Light indigo background */
            border-radius: 50%;
            padding: 6px;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .edit-product-icon:hover {
            background-color: #c7d2fe; /* Slightly darker indigo */
            transform: scale(1.1);
        }
        /* Dark mode for the all barcodes modal content */
        .dark #allBarcodesModal .modal-content {
            background-color: #1f2937;
            color: #f9fafb;
        }
        .dark #allBarcodesModalContent .barcode-item-in-modal {
            background-color: #374151;
        }
        .dark #allBarcodesModalContent .barcode-item-in-modal:hover {
            background-color: #4b5563;
        }
        .dark #allBarcodesModalContent .barcode-item-in-modal p {
            color: #f9fafb;
        }
        .dark .edit-product-icon {
            color: #a5b4fc; /* Light indigo for dark mode */
            background-color: #4f46e5; /* Darker indigo background */
        }
        .dark .edit-product-icon:hover {
            background-color: #6366f1; /* Slightly lighter indigo */
        }
        .dark #allBarcodesModalContent .barcode-item-in-modal canvas {
            border-color: #4b5563;
            background-color: #111827;
        }

        /* Stili per la modale "Aggiungi Nome Prodotto" */
        #addProductNameModal {
            z-index: 1004; /* Ancora più in alto per essere sopra le altre modali */
        }
        #addProductNameModal .modal-content {
            max-width: 450px;
        }


        /* Stili per la nuova modale "Archivio Prodotti" */
        #productArchiveModal {
            z-index: 1002; /* Più alto della modale base ma sotto quella di conferma */
        }
        #productArchiveModal .modal-content {
            max-width: 700px; /* Ancora più largo */
            height: 95%; /* Quasi a schermo intero in altezza */
            display: flex;
            flex-direction: column;
            text-align: left; /* Allinea testo a sinistra per la lista */
            padding: 25px;
        }
        #productArchiveModalContent {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 10px;
        }
        #productArchiveModalContent .product-item-in-archive {
            background-color: #f0f4f8; /* Light blue/gray background */
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #productArchiveModalContent .product-item-in-archive:hover {
            background-color: #e2e8f0; /* Lighter on hover */
        }
        #productArchiveModalContent .product-item-in-archive .barcode-value-display {
            font-weight: 600;
            color: #334155; /* Darker text */
            font-size: 1.1rem;
            word-break: break-all;
        }
        #productArchiveModalContent .product-item-in-archive .product-name-display {
            font-weight: 500;
            color: #1e40af; /* Blue text */
            font-size: 1.1rem;
            word-break: break-all;
        }
        #productArchiveModalContent .product-item-in-archive .delete-button {
            background-color: #ef4444; /* Red */
            color: white;
            border-radius: 9999px; /* Full rounded */
            padding: 8px; /* Aumentato il padding per l'icona */
            font-size: 0.8rem;
            margin-left: 10px;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #productArchiveModalContent .product-item-in-archive .delete-button:hover {
            background-color: #dc2626; /* Darker red */
        }
        /* Dark mode for product archive modal */
        .dark #productArchiveModal .modal-content {
            background-color: #1f2937;
            color: #f9fafb;
        }
        .dark #productArchiveModalContent .product-item-in-archive {
            background-color: #374151;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .dark #productArchiveModalContent .product-item-in-archive:hover {
            background-color: #4b5563;
        }
        .dark #productArchiveModalContent .product-item-in-archive .barcode-value-display {
            color: #f9fafb;
        }
        .dark #productArchiveModalContent .product-item-in-archive .product-name-display {
            color: #93c5fd; /* Light blue */
        }

        /* Stili per la nuova modale "Riepilogo Quantità Prodotti" */
        #productSummaryModal {
            z-index: 1002; /* Stesso livello dell'archivio e tutti i codici */
        }
        #productSummaryModal .modal-content {
            max-width: 600px;
            height: 90%;
            display: flex;
            flex-direction: column;
            text-align: left;
            padding: 25px;
        }
        #productSummaryModalContent {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 10px;
        }
        #productSummaryModalContent .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 1.1rem;
            color: #374151; /* Default color for light mode */
        }
        #productSummaryModalContent .summary-item:last-child {
            border-bottom: none;
        }
        #productSummaryModalContent .summary-item .product-name {
            font-weight: 600;
        }
        #productSummaryModalContent .summary-item .product-quantity {
            font-weight: 700;
            color: #1d4ed8; /* Blue-700 in light mode */
        }
        /* Dark mode for product summary modal */
        .dark #productSummaryModal .modal-content {
            background-color: #1f2937;
            color: #f9fafb; /* White for the modal content text */
        }
        .dark #productSummaryModalContent .summary-item {
            border-bottom-color: #4b5563;
            color: #f9fafb; /* Changed to white */
        }
        .dark #productSummaryModalContent .summary-item .product-quantity {
            color: #f9fafb; /* Changed to white */
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-2xl transform hover:scale-105 transition-transform duration-300">
        <!-- Logo TPC Group -->
        <div class="flex justify-center mb-4">
            <img src="https://media.licdn.com/dms/image/v2/C4E0BAQEp_ynYF_UExA/company-logo_200_200/company-logo_200_200/0/1642092550756/tpc_group_srl_logo?e=2147483647&v=beta&t=3f1SQUfd-kQeqQojJo7NUD_O2cbSdu0nO8hTz2maZs4" alt="TPC Group Logo" class="rounded-full shadow-md w-24 h-24 object-contain">
        </div>
        <h1 class="text-3xl font-bold text-center text-gray-900 dark:text-white mb-6">
            Lista Materiali
        </h1>

        <div class="mb-6">
            <label for="barcodeInput" class="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                Inserisci 12 o 13 cifre per il codice a barre:
            </label>
            <input
                type="number"
                id="barcodeInput"
                class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                placeholder="Es. 123456789012"
                oninput="handleBarcodeInput(this.value)"
            />
        </div>

        <!-- Display per Nome Prodotto Trovato (sulla schermata principale) -->
        <div class="mb-6 p-3 bg-blue-100 dark:bg-gray-700 rounded-lg border border-blue-200 dark:border-gray-600">
            <p class="text-gray-700 dark:text-gray-300 text-sm font-semibold mb-1">Nome Prodotto Trovato:</p>
            <p id="productNameDisplay" class="text-xl font-bold text-blue-800 dark:text-blue-300 break-words">Nessun prodotto trovato</p>
        </div>


        <!-- Nuovo bottone per Eliminare Ultimo Codice -->
        <button
            id="deleteLastButton"
            class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 mb-4 flex items-center justify-center space-x-2"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
            <span>Elimina Ultimo Materiale</span>
        </button>

        <!-- Contenitore per i bottoni Esporta PDF, Svuota Lista e Condividi -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <button
                id="exportPdfButton"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                <span>Esporta PDF</span>
            </button>
            <button
                id="clearListButton"
                class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brush-cleaning-icon lucide-brush-cleaning"><path d="m16 22-1-4"/><path d="M19 13.99a1 1 0 0 0 1-1V12a2 2 0 0 0-2-2h-3a1 1 0 0 1-1-1V4a2 2 0 0 0-4 0v5a1 1 0 0 1-1 1H6a2 2 0 0 0-2 2v.99a1 1 0 0 0 1 1"/><path d="M5 14h14l1.973 6.767A1 1 0 0 1 20 22H4a1 1 0 0 1-.973-1.233z"/><path d="m8 22 1-4"/></svg>
                <span>Svuota Lista</span>
            </button>
            <button
                id="sharePdfButton"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
                <span>Condividi PDF</span>
            </button>
        </div>

        <!-- Lista dei codici a barre "salvati" (ora solo il titolo e il conteggio) -->
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 text-center">Materiale Usato (<span id="savedCount">0</span>)</h2>
        <!-- Questo div rimarrà vuoto tranne per il messaggio iniziale se la lista è vuota -->
        <div id="savedBarcodesList" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-80 overflow-y-auto pr-2 custom-scrollbar mb-6">
            <p id="noSavedBarcodes" class="text-gray-500 dark:text-gray-400 text-center hidden">Nessun materiale salvato. Inizia a digitarne e salvarne uno!</p>
        </div>

        <!-- Nuovo bottone per aprire la modale dei codici acquisiti -->
        <button
            id="showAllBarcodesButton"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 mb-4 flex items-center justify-center space-x-2 hidden"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gallery-vertical"><path d="M3 2h18v18a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z"/><path d="M7 8h10"/><path d="M7 12h10"/><path d="M7 16h10"/></svg>
            <span>Mostra Tutti i Codici</span>
        </button>

        <!-- Nuovo bottone per aprire la modale dell'archivio prodotti -->
        <button
            id="manageProductArchiveButton"
            class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-2 mb-4 flex items-center justify-center space-x-2"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>
            <span>Gestisci Archivio Prodotti</span>
        </button>

        <!-- Nuovo bottone per aprire il riepilogo delle quantità -->
        <button
            id="showProductSummaryButton"
            class="w-full bg-lime-600 hover:bg-lime-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-lime-500 focus:ring-offset-2 mb-4 flex items-center justify-center space-x-2"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-list"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>
            <span>Riepilogo Quantità Prodotti</span>
        </button>

    </div>

    <!-- Modale per messaggi e conferme (esistente) -->
    <div id="myModal" class="modal">
        <div class="modal-content dark:bg-gray-700 dark:text-white">
            <span class="close-button dark:text-gray-300">&times;</span>
            <p id="modalMessage" class="text-lg text-gray-800 dark:text-gray-200 mb-4"></p>
            <div id="modalButtons" class="flex justify-center gap-4">
                <button id="modalConfirmBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg hidden">Sì, Elimina</button>
                <button id="modalCancelBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hidden">Annulla</button>
                <button id="modalOkBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <!-- Modale per Mostra Tutti i Codici Acquisiti -->
    <div id="allBarcodesModal" class="modal">
        <div class="modal-content dark:bg-gray-700">
            <span class="close-button close-all-barcodes-modal dark:text-gray-300">&times;</span>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 text-center">Tutti i Materiali Acquisiti</h2>
            <div id="allBarcodesModalContent" class="custom-scrollbar">
                <!-- I codici a barre con le immagini verranno caricati qui -->
            </div>
        </div>
    </div>

    <!-- Modale per Aggiungere/Modificare il Nome del Prodotto -->
    <div id="addProductNameModal" class="modal">
        <div class="modal-content dark:bg-gray-700">
            <span class="close-button close-add-product-name-modal dark:text-gray-300">&times;</span>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 text-center">Aggiungi Nome Prodotto</h2>
            
            <div class="mb-4">
                <label for="addProductNameModal_barcodeDisplay" class="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                    Codice a barre:
                </label>
                <p id="addProductNameModal_barcodeDisplay" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-100 dark:bg-gray-800 dark:text-white mb-3 font-mono text-lg text-center break-all"></p>
                
                <label for="addProductNameModal_productNameInput" class="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                    Nome Prodotto:
                </label>
                <input
                    type="text"
                    id="addProductNameModal_productNameInput"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white mb-3"
                    placeholder="Es. Cavo USB-C"
                />
                <div class="flex justify-center gap-4 mt-4">
                    <button
                        id="addProductNameModal_saveButton"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h10l6 6v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        <span>Salva Prodotto</span>
                    </button>
                    <button
                        id="addProductNameModal_cancelButton"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
                    >
                        <span>Annulla</span>
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Nuova Modale per l'Archivio Prodotti -->
    <div id="productArchiveModal" class="modal">
        <div class="modal-content dark:bg-gray-700">
            <span class="close-button close-product-archive-modal dark:text-gray-300">&times;</span>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 text-center">Gestione Archivio Prodotti</h2>
            
            <div class="mb-4">
                <label for="archiveBarcodeInput" class="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                    Codice a barre (per associazione/ricerca):
                </label>
                <input
                    type="number"
                    id="archiveBarcodeInput"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white mb-3"
                    placeholder="Inserisci 12 o 13 cifre"
                    oninput="lookupProductNameInArchiveModal(this.value)"
                />
                <label for="archiveProductNameInput" class="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                    Nome Prodotto:
                </label>
                <input
                    type="text"
                    id="archiveProductNameInput"
                    class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white mb-3"
                    placeholder="Es. Cavo USB-C"
                />
                <button
                    id="saveProductAssociationButton"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h10l6 6v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    <span>Salva/Aggiorna Associazione</span>
                </button>
            </div>

            <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3 text-center border-t pt-4 mt-4">Prodotti nell'Archivio:</h3>
            <div id="productArchiveListContent" class="flex-grow overflow-y-auto pr-2 custom-scrollbar">
                <!-- La lista delle associazioni barcode-nome sarà qui -->
                <p id="noProductArchiveItems" class="text-gray-500 dark:text-gray-400 text-center p-4 hidden">Nessun prodotto nell'archivio.</p>
            </div>
        </div>
    </div>

    <!-- NUOVA Modale per il Riepilogo Quantità Prodotti -->
    <div id="productSummaryModal" class="modal">
        <div class="modal-content dark:bg-gray-700">
            <span class="close-button close-product-summary-modal dark:text-gray-300">&times;</span>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 text-center">Riepilogo Quantità Materiali</h2>
            <div id="productSummaryModalContent" class="custom-scrollbar">
                <!-- Il riepilogo delle quantità verrà caricato qui -->
                <p id="noSummaryItems" class="text-gray-500 dark:text-gray-400 text-center hidden">Nessun materiale acquisito per il riepilogo.</p>
            </div>
            <!-- Nuovo bottone per Condividi PDF nel Riepilogo Quantità -->
            <button
                id="shareSummaryPdfButton"
                class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center space-x-2"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share-2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>
                <span>Condividi Riepilogo PDF</span>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification"></div>

    <!-- JsBarcode CDN -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Registra il Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                if (window.location.protocol !== 'http:' && window.location.protocol !== 'https:') {
                    console.warn('Avviso: Il Service Worker potrebbe non registrarsi correttamente se l\'applicazione non è servita tramite HTTP/HTTPS. Attualmente il protocollo è:', window.location.protocol);
                }

                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrato con successo:', registration);
                    })
                    .catch(error => {
                        console.error('Registrazione Service Worker fallita:', error);
                    });
            });
        }

        // Inizializza jsPDF dal namespace window
        const { jsPDF } = window.jspdf;

        // Elementi DOM Principali
        const barcodeInput = document.getElementById('barcodeInput');
        const exportPdfButton = document.getElementById('exportPdfButton');
        const deleteLastButton = document.getElementById('deleteLastButton');
        const clearListButton = document.getElementById('clearListButton');
        const sharePdfButton = document.getElementById('sharePdfButton');
        const savedBarcodesList = document.getElementById('savedBarcodesList');
        const savedCountSpan = document.getElementById('savedCount');
        const showAllBarcodesButton = document.getElementById('showAllBarcodesButton'); 
        const productNameDisplay = document.getElementById('productNameDisplay'); 
        const noSavedBarcodesMessage = document.getElementById('noSavedBarcodes');

        // Modali
        const modal = document.getElementById('myModal'); // Modale messaggi/conferme
        const allBarcodesModal = document.getElementById('allBarcodesModal'); // Modale tutti i codici
        const productArchiveModal = document.getElementById('productArchiveModal'); // Modale Archivio Prodotti
        const addProductNameModal = document.getElementById('addProductNameModal'); // Modale Aggiungi Nome Prodotto
        const productSummaryModal = document.getElementById('productSummaryModal'); // Modale Riepilogo Quantità

        // Contenuti delle modali
        const modalMessage = document.getElementById('modalMessage');
        const allBarcodesModalContent = document.getElementById('allBarcodesModalContent');
        const productArchiveListContent = document.getElementById('productArchiveListContent'); // Contenuto lista archivio
        const noProductArchiveItems = document.getElementById('noProductArchiveItems'); // Messaggio vuoto archivio
        const productSummaryModalContent = document.getElementById('productSummaryModalContent'); // Contenuto riepilogo
        const noSummaryItemsMessage = document.getElementById('noSummaryItems'); // Messaggio vuoto riepilogo


        // Campi e bottoni Archivio Prodotti (nella modale dedicata)
        const manageProductArchiveButton = document.getElementById('manageProductArchiveButton'); 
        const archiveBarcodeInput = document.getElementById('archiveBarcodeInput');
        const archiveProductNameInput = document.getElementById('archiveProductNameInput');
        const saveProductAssociationButton = document.getElementById('saveProductAssociationButton');

        // Elementi DOM per la modale Aggiungi Nome Prodotto
        const addProductNameModal_barcodeDisplay = document.getElementById('addProductNameModal_barcodeDisplay');
        const addProductNameModal_productNameInput = document.getElementById('addProductNameModal_productNameInput');
        const addProductNameModal_saveButton = document.getElementById('addProductNameModal_saveButton');
        const addProductNameModal_cancelButton = document.getElementById('addProductNameModal_cancelButton');

        // Elemento DOM per il bottone Riepilogo e NUOVO bottone Condividi Riepilogo PDF
        const showProductSummaryButton = document.getElementById('showProductSummaryButton');
        const shareSummaryPdfButton = document.getElementById('shareSummaryPdfButton'); // NUOVO

        // Bottoni di chiusura modali
        const closeButton = document.querySelector('.close-button'); // Chiusura modale messaggi/conferme
        const closeAllBarcodesModalButton = document.querySelector('.close-all-barcodes-modal'); // Chiusura modale tutti i codici
        const closeProductArchiveModalButton = document.querySelector('.close-product-archive-modal'); // Chiusura modale archivio
        const closeAddProductNameModalButton = document.querySelector('.close-add-product-name-modal'); // Chiusura modale aggiungi nome
        const closeProductSummaryModalButton = document.querySelector('.close-product-summary-modal'); // Chiusura modale riepilogo

        // Variabili di stato
        let saveTimeout;
        let isProgrammaticChange = false; 
        let currentOnConfirmCallback = null;
        let currentOnCancelCallback = null;
        let barcodeToEdit = null; // Memorizza il codice a barre che si sta modificando/aggiungendo il nome

        // --- Funzioni Generiche Modali e Toast ---

        function showModal(message, isConfirmation = false, onConfirm = null, onCancel = null) {
            modalMessage.textContent = message;
            modal.style.display = 'flex';
            if (isConfirmation) {
                modalOkBtn.classList.add('hidden');
                modalConfirmBtn.classList.remove('hidden');
                modalCancelBtn.classList.remove('hidden');
                currentOnConfirmCallback = onConfirm;
                currentOnCancelCallback = onCancel;
            } else {
                modalOkBtn.classList.remove('hidden');
                modalConfirmBtn.classList.add('hidden');
                modalCancelBtn.classList.add('hidden');
                currentOnConfirmCallback = null;
                currentOnConfirmCallback = null;
            }
        }

        function closeModal() {
            modal.style.display = 'none';
            currentOnConfirmCallback = null;
            currentOnCancelCallback = null;
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- Gestione Modale Archivio Prodotti ---

        function openProductArchiveModal() {
            productArchiveModal.style.display = 'flex';
            loadProductArchiveList(); // Carica la lista dei prodotti nell'archivio al momento dell'apertura
            archiveBarcodeInput.value = ''; // Pulisci l'input barcode all'apertura
            archiveProductNameInput.value = ''; // Pulisci l'input nome prodotto all'apertura
        }

        function closeProductArchiveModal() {
            productArchiveModal.style.display = 'none';
        }

        // --- Funzioni Archivio Prodotti (localStorage) ---

        /**
         * Funzione per leggere l'archivio prodotti da localStorage.
         * @returns {Array<Object>} Array di oggetti {barcode: string, name: string}
         */
        function getProductArchive() {
            try {
                const archive = localStorage.getItem('productArchive');
                return archive ? JSON.parse(archive) : [];
            } catch (e) {
                console.error("Errore nel recupero dell'archivio prodotti:", e);
                return [];
            }
        }

        /**
         * Funzione per salvare/aggiornare un'associazione barcode-nome nell'archivio.
         * @param {string} barcodeValue Il codice a barre.
         * @param {string} productName Il nome del prodotto associato.
         * @param {boolean} fromModal Indica se la chiamata proviene da una modale (per aggiornare le liste)
         */
        function saveProductToArchive(barcodeValue, productName, fromModal = false) {
            if (!barcodeValue || !productName) {
                showModal("Per salvare un prodotto, sono necessari sia il codice a barre che il nome del prodotto.");
                return;
            }
            if (!/^\d{12,13}$/.test(barcodeValue)) {
                showModal("Il codice a barre deve essere di 12 o 13 cifre numeriche valide (EAN13).");
                return;
            }

            let archive = getProductArchive();
            const index = archive.findIndex(item => item.barcode === barcodeValue);

            if (index > -1) {
                archive[index].name = productName; // Aggiorna il nome esistente
                showToast(`Nome prodotto "${productName}" aggiornato per il codice ${barcodeValue}!`);
            } else {
                archive.push({ barcode: barcodeValue, name: productName }); // Aggiungi nuova associazione
                showToast(`Prodotto "${productName}" salvato nell'archivio per il codice ${barcodeValue}!`);
            }
            localStorage.setItem('productArchive', JSON.stringify(archive));
            
            if (fromModal) {
                loadProductArchiveList(); // Aggiorna la lista nella modale "Gestisci Archivio Prodotti"
                if (allBarcodesModal.style.display === 'flex') {
                    showAllBarcodesInModal(); // Aggiorna anche la modale "Tutti i Materiali Acquisiti" se aperta
                }
                // Pulisci i campi solo se la chiamata non proviene da addProductNameModal (che ha la sua logica)
                if (fromModal !== 'addProductNameModal') {
                    archiveBarcodeInput.value = ''; 
                    archiveProductNameInput.value = '';
                }
            }
        }

        /**
         * Funzione per eliminare un'associazione barcode-nome dall'archivio.
         * @param {string} barcodeValueToDelete Il codice a barre da eliminare.
         */
        function deleteProductFromArchive(barcodeValueToDelete) {
            let archive = getProductArchive();
            const initialLength = archive.length;
            archive = archive.filter(item => item.barcode !== barcodeValueToDelete);

            if (archive.length < initialLength) {
                localStorage.setItem('productArchive', JSON.stringify(archive));
                showToast(`Associazione per il codice ${barcodeValueToDelete} eliminata dall'archivio!`);
                loadProductArchiveList(); // Aggiorna la lista nella modale "Gestisci Archivio Prodotti"
                if (allBarcodesModal.style.display === 'flex') {
                    showAllBarcodesInModal(); // Aggiorna anche la modale "Tutti i Materiali Acquisiti" se aperta
                }
            } else {
                showModal(`L'associazione per il codice ${barcodeValueToDelete} non è stata trovata nell'archivio.`);
            }
        }


        /**
         * Funzione per cercare e visualizzare il nome del prodotto sulla schermata principale.
         * @param {string} barcodeValue Il codice a barre da cercare.
         */
        function lookupProductName(barcodeValue) {
            const archive = getProductArchive();
            const foundItem = archive.find(item => item.barcode === barcodeValue);

            if (foundItem) {
                productNameDisplay.textContent = foundItem.name;
                return true; // Prodotto trovato
            } else {
                productNameDisplay.textContent = "Nessun prodotto trovato";
                return false; // Prodotto non trovato
            }
        }

        /**
         * Funzione per cercare il nome del prodotto e precompilare i campi nella modale dell'archivio.
         * @param {string} barcodeValue Il codice a barre da cercare.
         */
        function lookupProductNameInArchiveModal(barcodeValue) {
            if (!barcodeValue) {
                archiveProductNameInput.value = '';
                return;
            }
            const archive = getProductArchive();
            const foundItem = archive.find(item => item.barcode === barcodeValue);
            if (foundItem) {
                archiveProductNameInput.value = foundItem.name;
            } else {
                archiveProductNameInput.value = '';
            }
        }

        /**
         * Carica e visualizza la lista delle associazioni barcode-nome nella modale dell'archivio.
         */
        function loadProductArchiveList() {
            const archive = getProductArchive();
            productArchiveListContent.innerHTML = ''; // Pulisce la lista

            if (archive.length === 0) {
                noProductArchiveItems.classList.remove('hidden');
                productArchiveListContent.appendChild(noProductArchiveItems);
            } else {
                noProductArchiveItems.classList.add('hidden');
                // Ordina per barcode per una visualizzazione più chiara
                archive.sort((a, b) => a.barcode.localeCompare(b.barcode));

                archive.forEach(item => {
                    const productItemDiv = document.createElement('div');
                    productItemDiv.className = 'product-item-in-archive';
                    productItemDiv.innerHTML = `
                        <div class="flex-grow flex flex-col mr-4">
                            <p class="barcode-value-display">Codice: ${item.barcode}</p>
                            <p class="product-name-display">Nome: ${item.name}</p>
                        </div>
                        <button class="delete-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                        </button>
                    `;
                    // Aggiungi listener per il pulsante elimina
                    productItemDiv.querySelector('.delete-button').addEventListener('click', () => {
                        showModal(`Sei sicuro di voler eliminare l'associazione per il codice ${item.barcode} ("${item.name}")?`,
                            true,
                            () => deleteProductFromArchive(item.barcode)
                        );
                    });
                    productArchiveListContent.appendChild(productItemDiv);
                });
            }
        }

        // --- Funzioni Core App ---

        function handleBarcodeInput(value) {
            clearTimeout(saveTimeout); // Resetta il timer ad ogni nuova digitazione

            const trimmedBarcodeValue = value.trim();

            if (!trimmedBarcodeValue) {
                lookupProductName(''); // Pulisci display nome prodotto
                clearTimeout(saveTimeout); // Clear any pending save
                return;
            }

            // Validation for EAN13
            if (!/^\d{12,13}$/.test(trimmedBarcodeValue)) { // Checks for 12 or 13 digits
                lookupProductName(''); // Pulisci display nome prodotto
                showToast("EAN13 richiede esattamente 12 o 13 cifre numeriche.");
                return;
            }

            const productFound = lookupProductName(trimmedBarcodeValue); // Ricerca il nome prodotto qui

            // Se il prodotto non è stato trovato nell'archivio, mostra la toast notification
            if (!productFound) {
                showToast("Nuovo prodotto rilevato! Nessun nome associato nell'archivio.");
            }


            if (!isProgrammaticChange) {
                saveTimeout = setTimeout(() => {
                    const valueToSave = trimmedBarcodeValue;
                    
                    if (valueToSave) {
                        const barcodes = JSON.parse(localStorage.getItem('savedBarcodes') || '[]');
                        
                        barcodes.push({
                            value: valueToSave,
                            timestamp: Date.now()
                        });
                        localStorage.setItem('savedBarcodes', JSON.stringify(barcodes));
                        loadSavedBarcodes(true); // Aggiorna solo il conteggio e lo stato dei bottoni
                        showToast(`Materiale "${valueToSave}" salvato automaticamente!`);
                        
                        barcodeInput.classList.add('flash-success');
                        setTimeout(() => {
                            barcodeInput.classList.remove('flash-success');
                        }, 1000);
                        
                        barcodeInput.value = ''; // Pulisci l'input dopo il salvataggio
                    }
                }, 700);
            }
        }

        function loadSavedBarcodes(animateCount = false) {
            const barcodes = JSON.parse(localStorage.getItem('savedBarcodes') || '[]');
            savedBarcodesList.innerHTML = ''; // Pulisce la lista visualizzata
            savedCountSpan.textContent = barcodes.length;

            if (barcodes.length > 0) {
                savedCountSpan.classList.add('text-green-500', 'dark:text-green-400');
                if (animateCount) {
                    savedCountSpan.classList.add('count-flash-green');
                    setTimeout(() => {
                        savedCountSpan.classList.remove('count-flash-green');
                    }, 800);
                }
                showAllBarcodesButton.classList.remove('hidden'); // Mostra il pulsante se ci sono codici
                showProductSummaryButton.classList.remove('hidden'); // Mostra anche il riepilogo
                noSavedBarcodesMessage.classList.add('hidden'); // Nascondi il messaggio "Nessun materiale salvato"
            } else {
                savedCountSpan.classList.remove('text-green-500', 'dark:text-green-400');
                savedCountSpan.classList.remove('count-flash-green');
                showAllBarcodesButton.classList.add('hidden'); // Nascondi il pulsante se non ci sono codici
                showProductSummaryButton.classList.add('hidden'); // Nascondi anche il riepilogo
                noSavedBarcodesMessage.classList.remove('hidden'); // Mostra il messaggio "Nessun materiale salvato"
                savedBarcodesList.appendChild(noSavedBarcodesMessage); // Aggiungi il messaggio alla lista
            }


            if (barcodes.length === 0) {
                deleteLastButton.disabled = true;
                deleteLastButton.classList.add('opacity-50', 'cursor-not-allowed');
                exportPdfButton.disabled = true;
                exportPdfButton.classList.add('opacity-50', 'cursor-not-allowed');
                clearListButton.disabled = true;
                clearListButton.classList.add('opacity-50', 'cursor-not-allowed');
                sharePdfButton.disabled = true;
                sharePdfButton.classList.add('opacity-50', 'cursor-not-allowed');
                showAllBarcodesButton.disabled = true; 
                showAllBarcodesButton.classList.add('opacity-50', 'cursor-not-allowed');
                // manageProductArchiveButton.disabled = true; // Rimosso: il pulsante deve essere sempre abilitato
                // manageProductArchiveButton.classList.add('opacity-50', 'cursor-not-allowed'); // Rimosso
                showProductSummaryButton.disabled = true; // Disabilita anche il riepilogo
                showProductSummaryButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                deleteLastButton.disabled = false;
                deleteLastButton.classList.remove('opacity-50', 'cursor-not-allowed');
                exportPdfButton.disabled = false;
                exportPdfButton.classList.remove('opacity-50', 'cursor-not-allowed');
                clearListButton.disabled = false;
                clearListButton.classList.remove('opacity-50', 'cursor-not-allowed');
                sharePdfButton.disabled = false;
                sharePdfButton.classList.remove('opacity-50', 'cursor-not-allowed');
                showAllBarcodesButton.disabled = false; 
                showAllBarcodesButton.classList.remove('opacity-50', 'cursor-not-allowed');
                // manageProductArchiveButton.disabled = false; // Rimosso
                // manageProductArchiveButton.classList.remove('opacity-50', 'cursor-not-allowed'); // Rimosso
                showProductSummaryButton.disabled = false;
                showProductSummaryButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        deleteLastButton.addEventListener('click', () => {
            let barcodes = JSON.parse(localStorage.getItem('savedBarcodes') || '[]');
            if (barcodes.length > 0) {
                const lastItem = barcodes[barcodes.length - 1];
                const displayValue = lastItem.value;
                showModal(
                    `Sei sicuro di voler eliminare l'ultimo materiale: "${displayValue}"?`,
                    true,
                    () => {
                        barcodes.pop();
                        localStorage.setItem('savedBarcodes', JSON.stringify(barcodes));
                        loadSavedBarcodes(true);
                        showToast(`Materiale "${displayValue}" eliminato con successo!`);
                    },
                    () => {
                        showToast("Eliminazione annullata.");
                    }
                );
            } else {
                showModal("Non ci sono materiali da eliminare.");
            }
        });

        clearListButton.addEventListener('click', () => {
            let barcodes = JSON.parse(localStorage.getItem('savedBarcodes') || '[]');
            if (barcodes.length > 0) {
                showModal(
                    "Sei sicuro di voler svuotare l'intera lista dei materiali? Questa azione è irreversibile.",
                    true,
                    () => {
                        localStorage.removeItem('savedBarcodes');
                        loadSavedBarcodes(true);
                        showToast("Lista materiali svuotata con successo!");
                    },
                    () => {
                        showToast("Svuotamento lista annullato.");
                    }
                );
            } else {
                showModal("La lista è già vuota. Non ci sono materiali da svuotare.");
            }
        });

        /**
         * Apre la modale per aggiungere/modificare il nome del prodotto per un codice a barre specifico.
         * @param {string} barcode Il codice a barre da modificare/aggiungere.
         */
        function openAddProductNameModal(barcode) {
            barcodeToEdit = barcode; // Salva il codice a barre globale
            addProductNameModal_barcodeDisplay.textContent = barcode;
            addProductNameModal_productNameInput.value = ''; // Pulisci il campo nome
            addProductNameModal.style.display = 'flex';
            addProductNameModal_productNameInput.focus(); // Metti il focus sull'input
        }

        /**
         * Chiude la modale per aggiungere/modificare il nome del prodotto.
         */
        function closeAddProductNameModal() {
            addProductNameModal.style.display = 'none';
            barcodeToEdit = null; // Resetta il codice a barre in modifica
            addProductNameModal_productNameInput.value = ''; // Pulisci il campo input
        }

        function showAllBarcodesInModal() {
            const barcodes = JSON.parse(localStorage.getItem('savedBarcodes') || '[]');
            allBarcodesModalContent.innerHTML = '';

            if (barcodes.length === 0) {
                allBarcodesModalContent.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center p-4">Nessun materiale acquisito.</p>';
            } else {
                barcodes.sort((a, b) => b.timestamp - a.timestamp);

                const productArchive = getProductArchive();

                barcodes.forEach(item => {
                    const barcodeItemDiv = document.createElement('div');
                    barcodeItemDiv.className = 'barcode-item-in-modal';
                    // Non è più necessario il data-barcodeValue per il click sull'item, ma lo lascio per riferimento
                    // barcodeItemDiv.dataset.barcodeValue = item.value; 

                    const barcodeValueP = document.createElement('p');
                    barcodeValueP.className = 'font-semibold text-lg';
                    barcodeValueP.textContent = item.value;
                    barcodeItemDiv.appendChild(barcodeValueP);

                    const productInArchive = productArchive.find(p => p.barcode === item.value);
                    if (productInArchive) {
                        const productNameP = document.createElement('p');
                        productNameP.className = 'font-medium text-blue-600 dark:text-blue-300';
                        productNameP.textContent = productInArchive.name;
                        barcodeItemDiv.appendChild(productNameP);
                    } else {
                        // Se non c'è nome, aggiungi un placeholder o un messaggio
                        const productNameP = document.createElement('p');
                        productNameP.className = 'font-medium text-gray-500 dark:text-gray-400 text-sm italic';
                        productNameP.textContent = '(Nessun nome associato)';
                        barcodeItemDiv.appendChild(productNameP);

                        // Aggiungi l'icona per modificare/aggiungere il nome
                        const editIcon = document.createElement('button');
                        editIcon.className = 'edit-product-icon';
                        editIcon.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="M15 5l4 4"/></svg>
                        `;
                        editIcon.title = "Aggiungi/Modifica nome prodotto";
                        editIcon.addEventListener('click', (e) => {
                            e.stopPropagation(); // Evita che il click si propaghi all'elemento padre
                            openAddProductNameModal(item.value);
                        });
                        barcodeItemDiv.appendChild(editIcon);
                    }
                    
                    // Rimosso il display del timestamp
                    // const timestampP = document.createElement('p');
                    // timestampP.className = 'timestamp text-sm';
                    // timestampP.textContent = new Date(item.timestamp).toLocaleString();
                    // barcodeItemDiv.appendChild(timestampP);

                    const barcodeCanvasModal = document.createElement('canvas');
                    barcodeCanvasModal.className = 'w-full h-auto mt-2';
                    barcodeItemDiv.appendChild(barcodeCanvasModal);

                    allBarcodesModalContent.appendChild(barcodeItemDiv);

                    // Genera il codice a barre per la modale "Tutti i Materiali Acquisiti"
                    if (typeof JsBarcode !== 'undefined') {
                        try {
                            JsBarcode(barcodeCanvasModal, item.value, {
                                format: "EAN13",
                                displayValue: false, 
                                height: 60,
                                width: 2,
                                margin: 0,
                                lineColor: "#333"
                            });
                        } catch (e) {
                            console.error("Errore nella generazione del codice a barre per la modale:", e);
                            const errorText = document.createElement('p');
                            errorText.className = 'text-red-500 text-xs';
                            errorText.textContent = 'Errore codice';
                            barcodeItemDiv.appendChild(errorText);
                        }
                    }
                });
            }
            allBarcodesModal.style.display = 'flex';
        }

        function closeAllBarcodesModal() {
            allBarcodesModal.style.display = 'none';
        }

        // --- Funzioni Riepilogo Quantità Prodotti ---

        /**
         * Calcola il riepilogo delle quantità dei prodotti e lo restituisce come oggetto.
         * @returns {Object} Un oggetto dove le chiavi sono i nomi dei prodotti e i valori sono le quantità.
         */
        function getProductSummaryCounts() {
            const savedBarcodes = JSON.parse(localStorage.getItem('savedBarcodes') || '[]');
            const productArchive = getProductArchive();
            const productCounts = {}; // Oggetto per tenere il conteggio: { 'Nome Prodotto': quantità }

            savedBarcodes.forEach(item => {
                const productInArchive = productArchive.find(p => p.barcode === item.value);
                const productName = productInArchive ? productInArchive.name : `Codice: ${item.value}`; // Usa il nome o il codice
                
                if (productCounts[productName]) {
                    productCounts[productName]++;
                } else {
                    productCounts[productName] = 1;
                }
            });
            return productCounts;
        }

        /**
         * Visualizza il riepilogo delle quantità dei prodotti nella modale.
         */
        function displayProductSummary() {
            const productCounts = getProductSummaryCounts();
            productSummaryModalContent.innerHTML = ''; // Pulisce il contenuto precedente

            if (Object.keys(productCounts).length === 0) {
                noSummaryItemsMessage.classList.remove('hidden');
                productSummaryModalContent.appendChild(noSummaryItemsMessage);
                return;
            } else {
                noSummaryItemsMessage.classList.add('hidden');
            }

            // Ordina i prodotti per nome per una visualizzazione chiara
            const sortedProducts = Object.keys(productCounts).sort((a, b) => a.localeCompare(b));

            sortedProducts.forEach(name => {
                const summaryItemDiv = document.createElement('div');
                summaryItemDiv.className = 'summary-item';
                summaryItemDiv.innerHTML = `
                    <span class="product-name">${name}</span>
                    <span class="product-quantity">${productCounts[name]} unità</span>
                `;
                productSummaryModalContent.appendChild(summaryItemDiv);
            });
        }

        /**
         * Apre la modale del riepilogo delle quantità.
         */
        function openProductSummaryModal() {
            displayProductSummary(); // Genera e visualizza il riepilogo ogni volta che la modale viene aperta
            productSummaryModal.style.display = 'flex';
        }

        /**
         * Chiude la modale del riepilogo delle quantità.
         */
        function closeProductSummaryModal() {
            productSummaryModal.style.display = 'none';
        }

        /**
         * Genera un PDF del riepilogo quantità e lo restituisce come Blob.
         */
        function generateSummaryPdfBlob() {
            const doc = new jsPDF();
            let yPos = 10;

            doc.setFontSize(22);
            doc.text("Riepilogo Quantità Materiali", 105, yPos, { align: 'center' });
            yPos += 20; // Spazio maggiore dopo il titolo

            const productCounts = getProductSummaryCounts();
            const sortedProducts = Object.keys(productCounts).sort((a, b) => a.localeCompare(b));

            if (sortedProducts.length === 0) {
                doc.setFontSize(14);
                doc.text("Nessun materiale acquisito per il riepilogo.", 10, yPos);
            } else {
                doc.setFontSize(16);
                doc.text("Dettagli Riepilogo:", 10, yPos);
                yPos += 10;

                sortedProducts.forEach(name => {
                    const text = `${name}: ${productCounts[name]} unità`;
                    
                    // Controlla se c'è abbastanza spazio per il testo, altrimenti aggiungi una nuova pagina
                    if (yPos + 10 > doc.internal.pageSize.height - 10) {
                        doc.addPage();
                        yPos = 10; // Reset yPos for new page
                        doc.setFontSize(16);
                        doc.text("Riepilogo Quantità Materiali (continua)", 105, yPos, { align: 'center' });
                        yPos += 20; // Spazio dopo il titolo della nuova pagina
                    }

                    doc.setFontSize(12); // Dimensione testo per ogni riga
                    doc.text(text, 10, yPos);
                    yPos += 10; // Line height
                });
            }
            return doc.output('blob');
        }

        // Funzione per generare il PDF dalla lista completa e restituire il Blob (per download o condivisione)
        function generatePdfBlob() {
            const doc = new jsPDF();
            let yPos = 10;
            const productArchive = getProductArchive();

            doc.setFontSize(22);
            doc.text("Lista Materiali", 105, yPos, { align: 'center' });
            yPos += 10;

            const barcodes = JSON.parse(localStorage.getItem('savedBarcodes') || '[]');
            const currentBarcodeValue = barcodeInput.value.trim();
            let currentBarcodeImageUrl = null;

            // Genera l'immagine del codice a barre attuale solo se l'input è valido EAN13
            // Questa sezione crea un canvas temporaneo solo per la generazione PDF
            if (currentBarcodeValue && /^\d{12,13}$/.test(currentBarcodeValue)) {
                try {
                    // Crea un canvas temporaneo in memoria, non lo visualizza in pagina
                    const tempCanvasForCurrent = document.createElement('canvas');
                    JsBarcode(tempCanvasForCurrent, currentBarcodeValue, {
                        format: "EAN13",
                        displayValue: true,
                        height: 80,
                        width: 2,
                        margin: 10,
                        lineColor: "#333",
                        font: "Inter",
                        fontSize: 16
                    });
                    currentBarcodeImageUrl = tempCanvasForCurrent.toDataURL("image/png");
                } catch (e) {
                    console.error("Errore nella generazione del codice a barre EAN13 attuale per PDF:", e);
                }
            }


            if (currentBarcodeImageUrl && currentBarcodeValue) {
                doc.setFontSize(16);
                let currentItemText = "Codice Attuale: ";
                currentItemText += currentBarcodeValue;
                doc.text(currentItemText, 10, yPos);
                yPos += 10;
                const currentProduct = productArchive.find(p => p.barcode === currentBarcodeValue);
                if (currentProduct) {
                    doc.setFontSize(14);
                    doc.text(`Nome Prodotto: ${currentProduct.name}`, 10, yPos + 5);
                    yPos += 5;
                }
                doc.addImage(currentBarcodeImageUrl, 'PNG', 10, yPos, 100, 30);
                yPos += 40;
            } else {
                doc.setFontSize(16);
                doc.text("Nessun codice a barre attuale da esportare.", 10, yPos);
                yPos += 15;
            }

            if (barcodes.length > 0) {
                doc.setFontSize(18);
                doc.text("Materiale Usato:", 10, yPos);
                yPos += 10;

                barcodes.forEach((item, index) => {
                    const itemTotalHeight = 35 + (productArchive.find(p => p.barcode === item.value) ? 10 : 0);

                    if (yPos + itemTotalHeight > doc.internal.pageSize.height - 10) {
                        doc.addPage();
                        yPos = 10;
                        doc.setFontSize(18);
                        doc.text("Materiale Usato (continua)", 105, yPos, { align: 'center' });
                        yPos += 10;
                    }

                    const tempCanvas = document.createElement('canvas');
                    try {
                        JsBarcode(tempCanvas, item.value, {
                            format: "EAN13",
                            displayValue: false,
                            height: 50,
                            width: 1.5,
                            margin: 0
                        });
                        const barcodeImgData = tempCanvas.toDataURL("image/png");

                        doc.setFontSize(14);
                        doc.text(`${item.value}`, 10, yPos); // Rimosso il timestamp qui
                        yPos += 5;

                        const productInArchive = productArchive.find(p => p.barcode === item.value);
                        if (productInArchive) {
                            doc.setFontSize(12);
                            doc.text(`Nome: ${productInArchive.name}`, 10, yPos + 4);
                            yPos += 5;
                        }
                        doc.addImage(barcodeImgData, 'PNG', 10, yPos + 2, 80, 25);
                        yPos += 35;
                    } catch (e) {
                        console.error("Errore nella generazione del codice a barre EAN13 per l'elemento lista:", e);
                        doc.setFontSize(14);
                        doc.text(`- ${item.value} (Errore: formato EAN13 non valido)`, 10, yPos);
                        yPos += 15;
                    }
                });
            } else if (!currentBarcodeImageUrl) {
                doc.setFontSize(16);
                doc.text("Nessun materiale salvato da esportare.", 10, yPos);
            }
            return doc.output('blob');
        }

        // Funzione per esportare i codici a barre in PDF (download)
        exportPdfButton.addEventListener('click', () => {
            const pdfBlob = generatePdfBlob();
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "lista_materiali.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("PDF generato e pronto per il download!");
        });

        // Funzione per condividere il PDF via WhatsApp (o Web Share API)
        sharePdfButton.addEventListener('click', async () => {
            const pdfBlob = generatePdfBlob();
            const fileName = "lista_materiali.pdf";
            const filesArray = [new File([pdfBlob], fileName, { type: 'application/pdf' })];

            if (navigator.share && navigator.canShare && navigator.canShare({ files: filesArray })) {
                try {
                    await navigator.share({
                        files: filesArray,
                        title: 'Lista Materiali',
                        text: 'Ecco la lista dei materiali generata dalla mia app.',
                    });
                    showToast('PDF condiviso con successo!');
                } catch (error) {
                        console.error('Errore durante la condivisione:', error);
                    showModal("Impossibile condividere direttamente il PDF. Si prega di scaricare il PDF (Esporta PDF) e condividerlo manualmente tramite WhatsApp.");
                }
            } else {
                showModal("Il tuo browser o dispositivo non supporta la condivisione diretta di file. Si prega di scaricare il PDF (Esporta PDF) e condividerlo manualmente tramite WhatsApp.");
            }
        });

        // NUOVO Listener per il pulsante "Condividi Riepilogo PDF"
        shareSummaryPdfButton.addEventListener('click', async () => {
            const pdfBlob = generateSummaryPdfBlob();
            const fileName = "riepilogo_quantita_materiali.pdf";
            const filesArray = [new File([pdfBlob], fileName, { type: 'application/pdf' })];

            if (navigator.share && navigator.canShare && navigator.canShare({ files: filesArray })) {
                try {
                    await navigator.share({
                        files: filesArray,
                        title: 'Riepilogo Quantità Materiali',
                        text: 'Ecco il riepilogo delle quantità dei materiali acquisiti.',
                    });
                    showToast('Riepilogo PDF condiviso con successo!');
                } catch (error) {
                    console.error('Errore durante la condivisione del riepilogo:', error);
                    showModal("Impossibile condividere direttamente il Riepilogo PDF. Si prega di scaricare il PDF (Esporta PDF) e condividerlo manualmente.");
                }
            } else {
                showModal("Il tuo browser o dispositivo non supporta la condivisione diretta di file. Si prega di scaricare il Riepilogo PDF e condividerlo manualmente.");
            }
        });


        // --- Event Listeners ---

        closeButton.onclick = closeModal; // Modale messaggi/conferme
        modalOkBtn.onclick = closeModal;
        modalConfirmBtn.onclick = () => { if (currentOnConfirmCallback) currentOnConfirmCallback(); closeModal(); };
        modalCancelBtn.onclick = () => { if (currentOnCancelCallback) currentOnCancelCallback(); closeModal(); };

        closeAllBarcodesModalButton.onclick = closeAllBarcodesModal; // Modale tutti i codici
        closeProductArchiveModalButton.onclick = closeProductArchiveModal; // Modale archivio
        closeAddProductNameModalButton.onclick = closeAddProductNameModal; // Modale aggiungi nome
        closeProductSummaryModalButton.onclick = closeProductSummaryModal; // Modale riepilogo

        // Clic fuori dalle modali per chiuderle
        window.onclick = function(event) {
            if (event.target == modal) closeModal();
            if (event.target == allBarcodesModal) closeAllBarcodesModal();
            if (event.target == productArchiveModal) closeProductArchiveModal(); 
            if (event.target == addProductNameModal) closeAddProductNameModal();
            if (event.target == productSummaryModal) closeProductSummaryModal();
        }

        // Listener per il pulsante Salva/Aggiorna Associazione nella modale Archivio Prodotti
        saveProductAssociationButton.addEventListener('click', () => {
            const currentBarcode = archiveBarcodeInput.value.trim();
            const currentProductName = archiveProductNameInput.value.trim();
            saveProductToArchive(currentBarcode, currentProductName, 'productArchiveModal'); // Indica che viene da questa modale
        });

        // Listener per il campo input della modale Archivio Prodotti per la ricerca live
        archiveBarcodeInput.addEventListener('input', (event) => {
            lookupProductNameInArchiveModal(event.target.value);
        });

        // Listener per la modale Aggiungi Nome Prodotto
        addProductNameModal_saveButton.addEventListener('click', () => {
            const productName = addProductNameModal_productNameInput.value.trim();
            if (barcodeToEdit && productName) {
                saveProductToArchive(barcodeToEdit, productName, 'addProductNameModal'); // Indica che viene da questa modale
                closeAddProductNameModal();
            } else {
                showModal("Per favore, inserisci un nome prodotto.");
            }
        });

        addProductNameModal_cancelButton.addEventListener('click', closeAddProductNameModal);


        // Carica i codici a barre salvati all'avvio dell'app
        document.addEventListener('DOMContentLoaded', () => {
            loadSavedBarcodes();
            lookupProductName(''); // Inizializza il display del nome prodotto come "Nessun prodotto trovato"
            // manageProductArchiveButton.disabled = false; // Non più necessario qui, la logica è stata spostata/rimossa
            // manageProductArchiveButton.classList.remove('opacity-50', 'cursor-not-allowed'); // Non più necessario
        });

        // Listener per il nuovo pulsante "Mostra Tutti i Codici"
        showAllBarcodesButton.addEventListener('click', showAllBarcodesInModal);
        // Listener per il nuovo pulsante "Gestisci Archivio Prodotti"
        manageProductArchiveButton.addEventListener('click', openProductArchiveModal);
        // Listener per il pulsante "Riepilogo Quantità Prodotti"
        showProductSummaryButton.addEventListener('click', openProductSummaryModal);
    </script>

</body>
</html>
